<!DOCTYPE html>
<html>
<head>
<meta name="theme-color" content="#309090" />
<title>JS Shooter</title>
</head>
<body>
<center>
<canvas id="ctx" width="1200" height="600" style="border:1px solid #000000;"></canvas>
<div id="statusDiv" style="white-space: nowrap;"></div>
<button onclick="doubleFireSpeed()" disabled="true" id="upgradefs" style="white-space: nowrap;">Double fire speed (2000)</button>
<button onclick="dualBullets()" disabled="true" id="upgradedb" style="white-space: nowrap;">Dual bullets (5000)</button>
<button onclick="upgradeHP()" disabled="true" id="upgradehp" style="white-space: nowrap;">Upgrade HP (500)</button><br>
<textarea id="nameInput" maxlength="16">Unnamed</textarea>
<button id="setName" onclick="changeName()">Set name</button>
</center>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
	var canvas = document.getElementById('ctx');
	var ctx = canvas.getContext("2d");
	ctx.font = "10px Arial";

	var socket = io();
	var id = 0.0;
	var mx, my = 0;
	var upgHP = 500;

	socket.on("id", function(data) {
		console.log("Your id is " + data.id);
		id = data.id;
		setTimeout(function() {
			socket.emit("kthx");
		}, 100);
	});

	function upgradeHP() {
		setTimeout(function() {
			socket.emit("upgHPClicked");
		}, 100);
	} 

	function changeName() {
		var name = "" + document.getElementById("nameInput").value;
		socket.emit("changeName", {name:name});
	}

	function dualBullets() {
		setTimeout(function() {
			socket.emit("upgDualBullets");
		}, 100);
	}

	function doubleFireSpeed() {
		setTimeout(function() {
			socket.emit("upgFSpeedClicked");
		}, 100);
	}

	socket.on("price", function(data) {
		upgHP = data.upgHP;
		document.getElementById("upgradehp").innerHTML = "Upgrade HP (" + upgHP + ")";
		if(data.score >= upgHP) {
			document.getElementById("upgradehp").disabled = false;
		} else {
			document.getElementById("upgradehp").disabled = true;
		}

		if(data.dfs == true) {
			document.getElementById("upgradefs").disabled = true;
			document.getElementById("upgradefs").innerHTML = "Double fire speed";
		} else {
			document.getElementById("upgradefs").innerHTML = "Double fire speed (2000)";
			if(data.score >= 2000) {
				document.getElementById("upgradefs").disabled = false;
			} else {
				document.getElementById("upgradefs").disabled = true;
			}
		}

		if(data.dualBullets == true) {
			document.getElementById("upgradedb").disabled = true;
			document.getElementById("upgradedb").innerHTML = "Dual bullets";
		} else {
			document.getElementById("upgradedb").innerHTML = "Dual bullets (5000)";
			if(data.score >= 2000) {
				document.getElementById("upgradedb").disabled = false;
			} else {
				document.getElementById("upgradedb").disabled = true;
			}
		}
	});

	socket.on("newPositions", function(data) {
		ctx.clearRect(0,0,1200,600);
		for(var i = 0; i < data[0].players.length; i++) {
			if(data[0].players[i].id == id) {
				var status = "HP: " + data[0].players[i].hp + "/" + data[0].players[i].maxHp + " Score: " + data[0].players[i].score;
				ctx.fillStyle="#00ffaa";
			} else {
				ctx.fillStyle="#FF0000";
			}
			ctx.fillRect(data[0].players[i].x - 7, data[0].players[i].y - 7, 14, 14);
		}

		for(var i = 0; i < data[0].bullets.length; i++) {
			if(data[0].bullets[i].ownerID == id) {
				ctx.fillStyle="#008800";
				document.getElementById("statusDiv").innerHTML = status;
			} else {
				ctx.fillStyle="#880000";
			}
			ctx.beginPath();
			ctx.arc(data[0].bullets[i].x - 2,data[0].bullets[i].y - 2, 2, 0, Math.PI*2, true); 
			ctx.closePath();
			ctx.fill();
		}

		for(var i = 0; i < data[0].blocks.length; i++) {
			ctx.beginPath();
			ctx.fillStyle="#000000";
			ctx.fillRect(data[0].blocks[i].x - 5, data[0].blocks[i].y - 5, 10, 10);
			ctx.fillStyle="#00FF00";
			ctx.fillRect(data[0].blocks[i].x - 3, data[0].blocks[i].y - 3, 6, 6);
			ctx.closePath();
			ctx.fill();
		}
			
	});

	function getMousePos(canvas, evt) {
		var rect = canvas.getBoundingClientRect();
		return {
			x: evt.clientX - rect.left,
			y: evt.clientY - rect.top
		};
	}

	canvas.addEventListener('mousemove', function(evt) {
		var mousePos = getMousePos(canvas, evt);
		mx = mousePos.x;
		my = mousePos.y;
	}, false);
	
	// Sends mouse position to the server 20 times per second
	setInterval(function() {
		var pack = {
			x:mx,
			y:my
		};
		socket.emit('mouseMove',pack);
	}, 50);

    document.onkeydown = function(event){
        if(event.keyCode === 68)    //d
            socket.emit('keyPress',{inputId:'right',state:true});
        else if(event.keyCode === 83)   //s
            socket.emit('keyPress',{inputId:'down',state:true});
        else if(event.keyCode === 65) //a
            socket.emit('keyPress',{inputId:'left',state:true});
        else if(event.keyCode === 87) // w
            socket.emit('keyPress',{inputId:'up',state:true});
    }
    document.onkeyup = function(event){
        if(event.keyCode === 68)    //d
            socket.emit('keyPress',{inputId:'right',state:false});
        else if(event.keyCode === 83)   //s
            socket.emit('keyPress',{inputId:'down',state:false});
        else if(event.keyCode === 65) //a
            socket.emit('keyPress',{inputId:'left',state:false});
        else if(event.keyCode === 87) // w
            socket.emit('keyPress',{inputId:'up',state:false});
    }
</script>
</body>
</html>